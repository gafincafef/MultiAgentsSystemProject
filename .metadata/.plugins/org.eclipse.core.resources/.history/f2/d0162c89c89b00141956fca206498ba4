package edu.rits.ma.jade.behaviour;

import jade.core.AID;
import jade.lang.acl.ACLMessage;
import edu.rits.ma.common.abstr.ITask;
import edu.rits.ma.jade.communication.InProcessObjectMessage;
import edu.rits.ma.jade.communication.IncomingBuffer;
import edu.rits.ma.jade.communication.OutCommingBuffer;

public class SecondaryTaskProcessorImpl implements ICommunicationDataStoreProcessor {

	private static final int ACTION_PHASE_TO_WAIT = 0;
	private static final int ACTION_PHASE_TO_PROCESS_TASK_MESSAGE = 1;
	private static final int ACTION_PHASE_TO_STOP = 2;

	private int mInternalState = ACTION_PHASE_TO_WAIT;
	
	private String mPrimaryAgentName;
	
	public SecondaryTaskProcessorImpl(String primaryAgentName) {
		mPrimaryAgentName = primaryAgentName;
	}
	
	@Override
	public void processCommunicationDataStore(IncomingBuffer receiveBuffer, OutCommingBuffer sendBuffer) {
		updateInternalState(receiveBuffer);
		int newInternalState = mInternalState;
		switch (mInternalState) {
		case ACTION_PHASE_TO_PROCESS_TASK_MESSAGE:
			newInternalState = onTaskAssigned(sendBuffer);
			break;
		default:
			break;
		}
		mInternalState = newInternalState;
	}

	private int onTaskAssigned(CommunicationBuffer communicationBuffer) {
		InProcessObjectMessage objectMessage = communicationBuffer.extractObjectReceived();
		ITask task = (ITask) objectMessage.getObject();
		task.execute();
		ACLMessage taskDoneMessage = createTaskDoneMessage();
		communicationBuffer.addMessageToSend(taskDoneMessage);
		communicationBuffer.setState(CommunicationBuffer.STATE_TO_SEND_MESSAGE);
		return ACTION_PHASE_TO_STOP;
	}

	@Override
	public boolean done() {
		return mInternalState == ACTION_PHASE_TO_STOP;
	}

	private void updateInternalState(IncomingBuffer receivedBuffer) {
		if(communicationBuffer.getState() == CommunicationBuffer.STATE_MESSAGE_RECEIVED) {
			if(communicationBuffer.getReceivedInProcessObjectQueueSize() > 0) {
				mInternalState = ACTION_PHASE_TO_PROCESS_TASK_MESSAGE;
			}
		}
	}

	private ACLMessage createTaskDoneMessage() {
		//TODO Implement using ontology
		ACLMessage message = new ACLMessage(ACLMessage.INFORM);

		AID receiver = new AID(mPrimaryAgentName, AID.ISGUID);
		message.addReceiver(receiver);

		message.setContent("TaskDone");
		return message;
	}	
}
